# FanTree House
24.07.15 ~ 24.08.21 (5주)

## 프로젝트 설명

저희 프로젝트는 팬과 아티스트가 함께 소통하고 구독을 통한 개인화 된 서비스를 제공하여 더욱 가까운 관계를 형성할 수 있는 플랫폼입니다.

[[FanTreeHouse] 팬과 아티스트가 소통하는 서비스](https://www.notion.so/FanTreeHouse-ccc7b7b2e4b44872b3bd5ffd874a0b20?pvs=21) 

## 사용된 기술
- Framework : Spring Boot, Spring Batch(5.0.0), Flyway
- DB : MySQL, Redis, Flyway
- ETC : Docker, AWS(EC2, S3)

## 인원
Backend 5명

## 담당업무
- Team Leader 및 기획
    - **팀원들의 개인적인 역량을 파악**(이전 프로젝트의 담당 기능)하여 짧은 기간동안 결과를 만들어 내기 위해 **효율적으로 팀원들의 업무를 배치**하였음
    - **JD 직무 분석**을 통하여, 현재 **많은 기업들에서 중점적으로 보는 키워드**를 도출하기로 하였고, **대용량 트래픽 관리 경험**에 관한 질문이 빈번하였고, 이 점과 핵심 문화 산업인 K-POP을 활용하여 서비스를 기획함.
- 휴면 계정 자동 전환
    - 로그인 후 일정 기간동안 **재 로그인 하지 않은 회원들을 관리하는 방법**으로 **Spring Batch**를 사용하여 **일반 계정을 휴면 계정으로 전환**하는 로직과 다시 **인증을 통하여 휴면 계정에서 일반 계정으로 전환**시키는 로직을 담당
- 회원가입 / 로그인 로그아웃 / Security
    - **Security**를 이용해서 **회원관련 API 개발**
    - 로그인 컨트롤러를 개발하지 않고 **JwtAuthenticationFilter**에서 API 처리
- Oatuh
    - Oatuh docs를 통해 테이블에 필요한 필드 파악
    - 카카오 로그인 구현
- CI/CD 파이프라인 구축
    - **깃헙 액션**을 통해 백엔드 서버와 프론트엔드 서버를 각각 다른EC2 인스턴스에 도커 컨테이너를 설치한 후 올리는 방식을 이용

  ## 트러블 슈팅
  ### URL 설계와 API 명세서 개선: REST API 설계 최적화

- 초기 문제 상황
    1. **잘못된 URL 설계 접근**
    www.fantreehouse.com/{artistgroupname}/{postId}
    - 클라이언트 URL과 백엔드 API 엔드포인트 혼동
    - 필요 데이터(그룹 멤버, 소속사 정보 등) 누락
    1. **API 설계 오류**
    - 프론트엔드 라우팅 경로와 백엔드 API 엔드포인트 혼동
    - 필수 데이터 조회를 위한 연관 관계 고려 부족
- 해결 과정
    1. **API 엔드포인트 재설계**
    
    ```java
    // 백엔드 API 예시
    GET /api/v1/artist-groups/{groupId}
    GET /api/v1/artists/{artistId}/details
    GET /api/v1/posts/{postId}/with-group
    ```
    
    - RESTful API 설계 원칙 적용
    - 리소스 기반 URL 구조 확립
    1. **데이터 조회 최적화**
    - 테이블 ID 기반 조회 구조 구현
    - 연관 데이터 조인 쿼리 최적화
- 개선 결과
    1. **명확한 API 구조**
    - 백엔드 API와 프론트엔드 라우팅 분리
    - 리소스 중심의 엔드포인트 설계
    1. **효율적인 데이터 접근**
    - 필요한 모든 연관 데이터 정확한 조회

### Spring Batch - Meta Table 생성 오류

- 문제 상황
    1. **초기 요구사항**
        - 휴면 계정 자동 전환 시스템 구현 필요
        - Spring Batch를 통한 자동화 프로세스 구현 시도
    2. **발생한 문제**
        - JPA 테이블 자동 생성 설정에도 불구하고 Batch 메타 테이블 생성 실패
        - Spring Batch 3.0 이상 버전의 알려진 이슈
- 해결 과정
    1. **초기 해결 시도**
        - 메타 테이블 생성을 위한 SQL 직접 작성
        - 수동 쿼리 실행의 한계 인식 (배포 환경 고려)
    2. **Flyway 도입**
        - 데이터베이스 마이그레이션 자동화 도구 도입
        - 메타 테이블 생성 스크립트 버전 관리
- 개선 결과
    1. **자동화된 메타 테이블 관리**
        - 배포 환경에서 자동 테이블 생성
        - 버전 관리를 통한 안정적인 스키마 관리
    2. **배포 프로세스 개선**
        - 수동 개입 없는 자동화된 데이터베이스 마이그레이션
        - 일관된 개발/운영 환경 유지

### EC2 데이터베이스 해킹 사고 대응 및 복구

- 사고 발생 상황
    1. 초기 증상
        - EC2 DB 연결 중단 (8월 20일 오전 11:23)
        - 전체 테이블 Drop 확인
        - 랜섬웨어 감염 징후 발견 (RECOVER_YOUR_DATA 테이블)
    2. 원인 분석
        - Docker Compose 설정의 취약한 DB 패스워드
        - Public GitHub 저장소에 노출된 보안 정보
        - EC2 퍼블릭 접근 통제 미흡
- 대응 및 복구 과정
    1. **데이터 복구**
        - MySQL 바이너리 로그 분석
        - 사고 전 시점(8/19 20:00~21:00) 식별
        - 로그 기반 데이터 복구 실행
    2. **보안 강화 조치**
        - EC2 퍼블릭 IP 변경
        - MySQL 패스워드 정책 강화
- 향후 보완이 필요한 보안 정책 제안
    1. **인프라 보안 강화**
        - 보안 그룹 규칙 세분화
        - VPC 설정을 통한 네트워크 격리
        - DB 접근 IP 화이트리스트 관리
    2. **설정 관리 개선**
        - 환경 변수를 통한 민감 정보 관리
        - 설정 파일 암호화
        - Private Repository 전환

### ERD 정규화 및 최적화 과정 분석

- 주요 도메인 분리 및 정규화
    1. **아티스트(Artist) 도메인**
        - Artist_Group, Artist, Artist_Feed 테이블로 계층 구조화
        - 아티스트 정보와 피드 정보의 명확한 분리
        - 그룹과 개인 아티스트의 효율적 관리 구조 구현
    2. **사용자(User) 중심 설계**
        - 기본 User 테이블을 중심으로 연관 관계 설계
        - Entertainment, Community 등과의 관계 정립
        - 사용자 활동 관련 테이블들의 명확한 분리
    3. **커뮤니티(Community) 기능**
        - Community_Feed와 Comment 테이블의 논리적 분리
        - 좋아요(Like) 기능의 독립적 테이블화
        - 피드와 댓글의 계층 구조 명확화
- 정규화 적용 사항
    1. **제1정규형(1NF)**
        - 모든 테이블의 속성값을 원자값으로 구성
        - 반복 그룹 제거
    2. **제2정규형(2NF)**
        - 부분 종속성 제거
        - 각 테이블의 모든 컬럼이 기본키에 완전 종속되도록 설계
    3. **제3정규형(3NF)**
        - 이행적 종속성 제거
        - Artist - Entertainment - User 간의 관계 최적화
        - Feed와 Comment 시스템의 명확한 구조화
- 개선된 특징
    1. **관계의 명확성**
        - 각 엔티티 간 관계가 명확하게 정의됨
        - NOT NULL 제약조건을 통한 데이터 무결성 보장
    2. **확장성**
        - 새로운 기능 추가가 용이한 구조
        - 각 도메인별 독립적인 확장 가능
    3. **유지보수성**
        - 명확한 테이블 구조로 유지보수 용이
        - 데이터 조회 및 수정이 직관적
      
## 기술 의사 결정

### 데이터 베이스 : MySQL

- 비교 대상 : PostgreSQL
    1. 트랜잭션 처리 및 성능
        - MySQL
            - 읽기 작업에 최적화된 성능
            - 상대적으로 가벼운 리소스 사용
        - PostgreSQL
            - 복잡한 쿼리와 대규모 데이터에 적합
            - 더 많은 리소스 필요
    2. 프로젝트 특성 부합도
        - MySQL
            - 읽기 작업이 많은 커뮤니티 서비스에 최적화
            - 단순하고 빠른 쿼리 처리 필요
            - 대규모 JOIN이나 복잡한 쿼리가 적은 서비스 구조
        - PostgreSQL
            - 고급 인덱싱 기능 활용도 낮음
            - 지리정보 처리 기능 불필요
            - 복잡한 데이터 타입 사용 계획 X
- 최종 선택 이유
    - 커뮤니티 활성화도로 인한 문제 해결 용이
    - 팬 커뮤니티 서비스에 적합한 읽기 성능
    - 안정적인 트랜잭션 처리

### 배치 처리 : Spring Batch

- 비교 대상 : Quartz
    1. 데이터 처리 방식
        - Spring Batch:
            - Chunk 기반의 안정적인 대용량 데이터 처리
            - 트랜잭션 관리 및 롤백 기능 내장
            - 실패 지점부터 재시작 가능한 상태 관리
        - Quartz:
            - 단순 작업 스케줄링에 초점
            - 개별 작업 단위의 관리
            - 데이터 처리보다 시간 기반 실행에 강점
    2. 프로젝트 요구사항 부합성
        - Spring Batch의 장점:
            - 휴면 계정 일괄 처리에 적합한 구조
            - 데이터 정합성 보장
            - 장애 발생 시 자동 복구 매커니즘
        - Quartz의 한계:
            - 대량 데이터 처리 시 성능 이슈 가능성
            - 복잡한 데이터 처리 로직 구현의 어려움
            - 배치 처리 전용 기능 부재
- 최종 선택 이유
    - 대용량 데이터의 안정적 처리
    - 강력한 장애 복구 메커니즘
    - 상세한 모니터링과 관리기능

### DB 마이그레이션 도구 : Flyway

- 비교대상 : Liquibase
    1. 개발 생산성
        - Flyway
            - SQL 직접 작성으로 즉각적인 수정 가능
            - 버전 관리가 직관적
            - 학습 비용 최소화
        - Liquibase
            - XML/YAML 설정의 복잡성
            - 추가 문법 학습 필요
            - 자동 생성 롤백 스크립트의 신뢰성 문제
    2. 유지 보수성
        - Flyway가 더 적합한 이유
            - 순수 SQL 사용으로 디버깅 용이
            - 변경 이력 추적 명확
            - Spring Batch 메타 테이블 관리 통합 용이
        - Liquibase가 불필요한 이유:
            - 복잡한 롤백 시나리오 불필요
            - 다중 DB 벤더 지원 필요성 없음
            - 자동화된 변경 사항 병합 기능 불필요
- 최종 선택 이유
    - SQL 기반의 직관적인 마이그레이션
    - Spring Batch 메타 테이블 관리 용이
    - 프로젝트 규모에 적합한 단순성

**시연영상**

https://www.youtube.com/watch?v=1XSJfZ4KJhU

**프로젝트 Github**

https://github.com/FanTree-House/FanTree-Back

**프로젝트 Notion**

[https://teamsparta.notion.site/67b0dd55fd384f6bbe2f635feb4d0c38](https://www.notion.so/67b0dd55fd384f6bbe2f635feb4d0c38?pvs=21)
  
  
